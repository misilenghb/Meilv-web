# 📋 订单状态系统统一计划

## 🎯 目标
统一系统中的订单状态定义，解决当前大小写状态混用的问题。

## 📊 现状分析

### 当前状态系统
1. **小写状态系统** (`src/lib/order-status.ts`)
   - `pending`, `confirmed`, `in_progress`, `completed`, `cancelled`

2. **大写状态系统** (`src/types/domain.ts`)
   - `DRAFT`, `GUIDE_SELECTED`, `DEPOSIT_PENDING`, `DEPOSIT_PAID`, `PAID`, `IN_PROGRESS`, `COMPLETED`, `CANCELLED`, `REFUNDED`

3. **数据库实际状态**
   - 主要使用小写状态：`pending`, `confirmed`, `in_progress`, `completed`, `cancelled`
   - 部分新订单可能使用大写状态

## 🔄 统一方案

### 选择：使用小写状态系统
**理由**：
1. 数据库中现有数据主要使用小写状态
2. 减少数据迁移复杂度
3. 符合数据库命名约定

### 统一后的状态定义
```typescript
export type OrderStatus = 
  | 'pending'        // 待分配地陪 (对应原 DRAFT)
  | 'confirmed'      // 已分配地陪，等待收款 (对应原 GUIDE_SELECTED/DEPOSIT_PENDING)
  | 'deposit_paid'   // 已收保证金，等待见面 (对应原 DEPOSIT_PAID)
  | 'in_progress'    // 服务进行中 (对应原 IN_PROGRESS)
  | 'completed'      // 已完成 (对应原 COMPLETED)
  | 'cancelled'      // 已取消 (对应原 CANCELLED)
  | 'refunded'       // 已退款 (对应原 REFUNDED)
```

## 🛠️ 实施步骤

### 第一阶段：创建统一状态管理
1. 创建新的状态定义文件
2. 创建状态映射函数
3. 创建状态转换验证函数

### 第二阶段：更新API层
1. 更新所有API使用统一状态
2. 添加向后兼容性支持
3. 更新状态检查逻辑

### 第三阶段：更新前端
1. 更新前端状态显示
2. 更新状态判断逻辑
3. 测试所有状态转换

### 第四阶段：数据库清理
1. 统一数据库中的状态值
2. 更新数据库约束
3. 移除临时兼容代码

## 📝 具体修改清单

### 需要修改的文件
1. `src/types/domain.ts` - 更新状态类型定义
2. `src/lib/order-status.ts` - 扩展状态管理
3. `src/lib/order-adapter.ts` - 更新状态映射
4. 所有API文件中的状态检查逻辑
5. 前端组件中的状态显示逻辑

### 需要添加的功能
1. 状态映射函数（大写→小写）
2. 状态验证函数
3. 状态转换日志
4. 错误处理改进

## ⚠️ 风险评估

### 高风险
- 数据库状态不一致可能导致订单无法正常处理
- API状态检查失败可能阻止正常业务流程

### 中风险  
- 前端显示可能出现临时不一致
- 状态转换逻辑可能需要调试

### 低风险
- 用户体验可能有短暂影响
- 需要额外的测试时间

## 🧪 测试计划

### 单元测试
- 状态转换函数测试
- 状态验证函数测试
- 状态映射函数测试

### 集成测试
- API状态检查测试
- 订单流程端到端测试
- 错误处理测试

### 用户验收测试
- 创建订单流程
- 状态转换流程
- 删除/取消订单流程

## 📅 时间估算

| 阶段 | 工作量 | 时间 |
|------|--------|------|
| 第一阶段 | 4小时 | 0.5天 |
| 第二阶段 | 8小时 | 1天 |
| 第三阶段 | 6小时 | 0.75天 |
| 第四阶段 | 4小时 | 0.5天 |
| 测试验证 | 6小时 | 0.75天 |
| **总计** | **28小时** | **3.5天** |

## 🚀 实施建议

1. **分阶段实施**：避免一次性大规模修改
2. **保持向后兼容**：在过渡期支持两套状态
3. **充分测试**：每个阶段完成后进行测试
4. **监控日志**：密切关注错误日志和用户反馈
5. **回滚准备**：准备快速回滚方案

## 📞 下一步行动

1. 确认统一方案
2. 开始第一阶段实施
3. 设置监控和日志
4. 准备测试环境
5. 制定回滚计划
